# Interfacing bmp180 over i2c
# Barometric pressure sensor
#
# https://cdn-shop.adafruit.com/datasheets/BST-BMP180-DS000-09.pdf
# --

: ADDR 0x77 ; 

# Wait for device ready, by verifying twi:tr:end returns 0 

: Ready! loop{ ADDR twi:tr:begin twi:tr:end 0 == break } ;

: delay ( :uint =ms ) 
	millis ms + =ms loop{ millis ms > break }
	;

: CTRL 0xf4 ;
: OUT_MSB 0xF6 ;
: OUT_LSB 0xF7 ;
: ID 0xD0 ;     # should return 0x55
: RESET 0xE0 ;  # write 0xB6 to reset device

# CTRL mode values

: T 0x2E ;  # temp
: P0 0x34 ;  # pressure over-sampling 0 - fastest
: P1 0x74 ;
: P2 0x84 ;
: P3 0xF4 ;

: W ( :byte =reg :byte =val )
	Ready!
	ADDR twi:tr:begin
	reg twi:write
	val twi:write
	twi:tr:end pop
;

: R ( :byte =reg ) 
	Ready!
	ADDR twi:tr:begin
	reg twi:write
	twi:tr:end pop
	ADDR 1 twi:request
	twi:read
;

: reset
	RESET 0xB6 W
;

# Verify connection

: check
	twi:begin
	ID R 0x55 ==
	twi:end
;


# The control register ctrl_meas sco-bit (start conversion)
# remains 1 until conversion complete
#
# Does not seem to work!

: wc
	loop{
		CTRL R 
			B00100000 &
				break
	}
;
	
# Get uncalibrated temp
: T!
	twi:begin
	CTRL T W
	#wc
	25 delay
	OUT_MSB R 8 <<
		OUT_LSB R |
 	=result
	twi:end
	result
	;



# Get uncalibrated pressure
: P!
	twi:begin
	CTRL P3 W
	#wc
	25 delay
	OUT_MSB R 8 <<
		OUT_LSB R |
 	=result
	twi:end
	result
	;
		
# Calculating millibars



