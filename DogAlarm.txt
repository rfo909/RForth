(
If low sensor detects movement and the
high sensors have not for at least 10 seconds,
then sound the alarm
)

(pins)
14 CONSTANT LowSensor
15 CONSTANT HighSensor

13 CONSTANT Speaker

(timers)
1 CONSTANT tHigh
2 CONSTANT tLow

: Read (pin--value) NATIVE Pin.ReadDigital ;
: Millis (timer -- millis) NATIVE Sys.TimerGet ;
: Start (timer -- ) NATIVE Sys.TimerSet ;
: Cancel (timer -- ) NATIVE Sys.TimerCancel ;

: Init
  LowSensor NATIVE Pin.ModeIn
  HighSensor NATIVE Pin.ModeIn
  Speaker NATIVE Pin.ModeOut
;


: Sense
  HighSensor Read IF tHigh Start THEN
  
  (can not restart tLow timer on every cycle, as
  it controls the alarm sound)
  
  LowSensor Read 
    tLow Millis 5000 > && 
  IF 
    tLow Start 
  THEN
;

: modulo (a b -- rem)
  => b => a
  a b / b * a swap -
;


EMPTY-WORD Alarm
EMPTY-WORD Silence

: Alarm?
  0 => play
  
  (delay the tLow timer by a quarter of a second,
   to allow for the tHigh to be enabled, if there
   is a person there after all
  )
  tHigh Millis 10000 >
    tLow Millis 250 > && 
    tLow Millis 2000 < &&
  IF 
    Alarm
  ELSE
    Silence
  THEN
;

: Alarm
  tLow Millis 
    100 / 
    2 modulo 
      Speaker NATIVE Pin.WriteDigital
;

: Silence
  0 Speaker NATIVE Pin.WriteDigital
;

: Status
;
  
  

: Main
  Init BEGIN 
    Sense 
    Alarm?
    Status
    key not AGAIN?
    cr "Terminated .str
;

HERE 4154 - .


