( the #END mark is used to cut the rest of the file off as input to the interpreter )
( --------------------------------------------------------------------------------- )

HERE CONSTANT beforeCode


( --- example: solar charger --- )
( A low voltage, low power solar panel is coupled to a capacitor )
( Since the panel efficiency is best when the load isn't draining it, we only forward current when that cap is above a certain value)
( The current is forwarded as a pulse through an inductor, via a small resistor )
( When the current stops, the inductor discharges through a diode into the charge capacitor )
( When the voltage of the charge cap exceeds the battery voltage by a certain amount, we send a pulse from it to the battery )
( Unless the battery is full, then we wait until voltage drops below a certain threshold )

( If the input voltage on the solar panel capacitor is too low, then the microcontroller goes to deep sleep )
( The max duration of this sleep for atmega328p is 8 seconds )


(--- native stuff ---)

: outDigital ( pin value -- ) drop drop	;
: inAnalog  ( pin ) drop		;
: inDigital  ( pin ) drop		;

: writeDigital ( pin value -- ) drop drop ;
: readDigital  ( pin -- value ) drop 1 ;
: readAnalog   ( pin -- value ) drop 512 ;

: pulseMicros  ( pin value -- ) drop drop ;

: sleep8s ( deep sleep 8 seconds ) ;
: sleepMillis ( millis -- ) ;

(--- pins ---)

4 CONSTANT solarVoltagePin
5 CONSTANT battVoltagePin
6 CONSTANT chargeVoltagePin	(charge cap pumped up via inductor)
8 CONSTANT valveSolar
8 CONSTANT valveCharge
9 CONSTANT valveAref

10 CONSTANT ledCharge
11 CONSTANT ledInductor
12 CONSTANT ledFull

13 CONSTANT enableLoad

: Init
	solarVoltagePin inAnalog
	battVoltagePin  inAnalog
	chargeVoltagePin inAnalog

	valveSolar 0 outDigital
	valveCharge 0 outDigital
	valveAref 1 outDigital

	ledCharge 0 outDigital
	ledInductor 0 outDigital
	ledFull 0 outDigital

	enableLoad 0 outDigital
	;

: DeepSleep
	valveSolar 0 writeDigital
	valveCharge 0 writeDigital
	valveAref 0 writeDigital

	ledCharge 0 writeDigital
	ledInductor 0 writeDigital

	enableLoad 0 writeDigital

	sleep8s
	;

( voltages given 0-1023 analog read value AND voltage divider setups )
634 CONSTANT solarVoltageOk
850 CONSTANT battVoltageMax
456 CONSTANT battVoltageLoadMin  (below this, kill external load, signaled via the enableLoad pin)
		
: SolarVoltage solarVoltagePin readAnalog ;
: BattVoltage battVoltagePin readAnalog ;
: ChargeVoltage chargeVoltagePin readAnalog ;
: CanPowerLoad  BattVoltage battVoltageLoadMin ge ;

: ChargeVoltageOk (? does charge cap contain high enough voltage to charge battery ?)
	BattVoltage 125 add 
	ChargeVoltage
		gt
	;

: BatteryFull (? is battery voltage at max ?)
	BattVoltage battVoltageMax gt ;
	;


10000 CONSTANT sleepInterval  ( longer sleep after this number of cycles, to give battery rest )
sleepInterval VARIABLE sleepCountDown

: MakePause?
	sleepCountDown 0 eq IF 
		20000 sleepMillis
		sleepInterval sleepCountDown !
	THEN
	sleepCountDown @ 1 sub sleepCountDown !
;



: Charge

	(compiles to 80 bytes :-)

	enableLoad CanPowerLoad writeDigital 

	SolarVoltage solarVoltageOk lt IF 
		DeepSleep
		ret		(never called, as sleep restarts microcontroller)
	THEN

	MakePause?

	BatteryFull IF 
		ledFull 1 writeDigital
		ret 
	THEN

	ledFull 0 writeDigital
	
	ChargeVoltageOk IF
		valveCharge 5 1 pulseMicros  (charge battery for 5 us)
		1 ledCharge writeDigital
		0 ledInductor writeDigital
		ret
	THEN

	0 ledCharge writeDigital

	valveSolar 1 1 pulseMicros ( charge inductor for 1 us)

	1 ledInductor writeDigital

	;


: Main 
	Init 
	BEGIN
		1 sleepMillis 
		Charge 
	1 AGAIN? ;


: testLoop 50 cpush BEGIN
	cr a print#
	a 1 sub a!
	a 0 gt AGAIN?
	"done .str
	;

HERE CONSTANT afterCode

cr cr "#bytes_ .str afterCode beforeCode sub print#
cr cr


cr "SUCCESS:_everything_works .str

(start running)
\ Main

#END

