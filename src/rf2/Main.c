#include "common.h"

Long dstack[DSTACK_DEPTH];
Byte dStackPos=0;

Byte *heap;
int heapPointer=0;


void main () {
    initHeap();
}

Ref getCurrCSF () {
    Ref nextFrame=readRef(H_CS_NEXT_FRAME);
    if (nextFrame==0) {
        PANIC("CS empty");
        return null;
    }
    return readRef(H_CS_BASE_REF) + (nextFrame-1)*CSF_n;
}

// Execute op-code

void execute()
{
    int op = nextByte();
    switch (op)
    {
    case OP_JMP:
        Ref addr = dsPopRef();
        Ref currCSF = getCurrCSF(); // may create if none found
        writeRef(currCSF + CSF_pc, addr);
        break;
    case OP_COND_JMP:
        Ref addr = dsPopRef();
        Long cond = dsPopInt4();
        if (cond != null)
        {
            Ref currCSF = getCurrCSF(); // may create if none found
            writeRef(currCSF + CSF_pc, addr);
        }
        break;
    case OP_CALL:
        Ref addr = dsPopRef();
        Ref currCSF = getCurrCSF();
        Byte nextFrame = readByte(H_CS_NEXT_FRAME);
        writeByte(H_CS_NEXT_FRAME, nextFrame + 1);
        Ref newCSF = getCurrCSF();
        Byte tsNext = readByte(currCSF + CSF_tempStackNext);
        writeRef(newCSF + CSF_code, addr);
        writeByte(newCSF + CSF_tempStackBase, tsNext);
        writeByte(newCSF + CSF_tempStackNext, tsNext);
        writeRef(newCSF + CSF_pc, 0);
        break;
    case OP_RETURN:
        Byte x = readByte(CS_NEXT_FRAME);
        writeByte(CS_NEXT_FRAME, x - 1);
        break;
    case OP_PANIC:
        Ref word = dsPopRef();
        char *str = safeGetString(word);
        emitStr("PANIC ");
        emitStr(str);
        emitNewline();
        setPanicFlag();
        break;
    case OP_HEAP_MAX:
        dsPushInt2(HEAP_SIZE);
        break;
    case OP_TIBs:
        dsPushInt1(getTIBsChar());
        break;
    case OP_TIBr:
        dsPushInt1(getTIBrChar());
        break;
    case OP_TIBr_ADD:
        advanceTIBr();
        break;
    case OP_TIBs_ADD:
        advanceTIBs();
        break;
    case OP_TIBr_BACK:
        resetTIBr();
        break;
    case OP_TIBs_FWD:
        confirmTIBr();
        break;
    case OP_TIBW:
        char *str = getTIBWord();
        Ref ref = getSymRef(str);
        dsPushRef(ref);
        break;
    case OP_EMIT:
        char c = dsPopInt1();
        emitChar(c);
        break;
    case OP_EMITWORD:
        Ref ref = dsPopRef();
        char *str = safeGetStr(ref);
        emitStr(str);
        break;
    case OP_ADD:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        dsPushInt4(a + b);
        break;
    case OP_SUBTRACT:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        dsPushInt4(a - b);
        break;
    case OP_MUL:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        dsPushInt4(a * b);
        break;
    case OP_DIV:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        dsPushInt4(a / b);
        break;
    case OP_MOD:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        dsPushInt4(a % b);
        break;
    case OP_RIGHTSHIFT:
        Long n = dsPopInt4();
        Long val = dsPopInt4();
        dsPushInt4(val >> n);
        break;
    case OP_LEFTSHIFT:
        Long n = dsPopInt4();
        Long val = dsPopInt4();
        dsPushInt4(val << n);
        break;
    case OP_AND:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a & b != 0)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_OR:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a | b != 0)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_NOT:
        Long val = dsPopInt4();
        dsPushInt4(~val);
        break;
    case OP_EQ:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a == b)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_NE:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a != b)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_GT:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a > b)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_LT:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a < b)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_GE:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a >= b)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_LE:
        Long b = dsPopInt4();
        Long a = dsPopInt4();
        if (a <= b)
            dsPushInt4(F_TRUE);
        else
            dsPushInt4(F_FALSE);
        break;
    case OP_DROP:
        dsPopInt4();
        break;
    case OP_SETLOCAL:
        Long value = dsPopInt4();
        Ref sym = dsPopRef();
        setLocalValue(sym, value);
        break;
    case OP_GETLOCAL:
        Ref sym = dsPopRef();
        dsPushValue(getLocalValue(sym));
        break;
    case OP_WORD:
        // create word from substring of existing word
        Ref ref = dsPopRef();
        char *str = safeGetString(ref);
        addSymbol(str);
        break;
    case OP_WRITE1:
        Ref ref = dsPopRef();
        long val = dsPopInt4();
        writeByte(ref, val);
        break;
    case OP_WRITE2:
        Ref ref = dsPopRef();
        long val = dsPopInt4();
        write2(ref, val);
        break;
    case OP_WRITE4:
        Ref ref = dsPopRef();
        long val = dsPopInt4();
        write4(ref, val);
        break;
    case OP_READ1:
        Ref ref = dsPopRef();
        dsPushInt1(readInt1(ref));
        break;
    case OP_READ2:
        Ref ref = dsPopRef();
        dsPushInt2(readInt2(ref));
        break;
    case OP_READ4:
        Ref ref = dsPopRef();
        dsPushInt4(readInt4(ref));
        break;
    case OP_READ1g:
        Long addr = dsPopInt4();
        dsPushInt1(readGlobal(addr));
        break;
    case OP_WRITE1g:
        Long addr = dsPopInt4();
        Byte value = dsPopInt1();
        writeGlobal(addr, value);
        break;
    case OP_LITERAL1:
        dsPushInt1(nextByte());
        break;
    case OP_LITERAL2:
        Byte a = nextByte();
        Byte b = nextByte();
        dsPushInt2(a << 8 | b);
        break;
    case OP_LITERAL4:
        Byte a = nextByte();
        Byte b = nextByte();
        Byte c = nextByte();
        Byte d = nextByte();
        dsPushInt4(a << 24 | b << 12 | c << 8 | d);
        break;
    case OP_CHECK_PARSE:
        Ref symRef = dsPopRef();
        char *str = safeGetString(symRef);
        if (checkParseInt(str))
            dsPushValue(F_TRUE);
        else
            dsPushValue(F_FALSE);
        break;
    case OP_PARSE:
        Ref symRef = dsPopRef();
        char *str = safeGetString(symRef);
        dsPushInt4(parseInt(str));
        break;
    }
}




void initHeap() {
    // ACode.txt 
    heap=malloc(HEAP_SIZE);
    memcpy(heap, data, dataLength);
    heapPointer=dataLength;
}

// ------------------------------------------------------
// Assembler:Compile output
// ------------------------------------------------------

int dataLength = 2682;
Byte data[] = {
    0,7,174,8,81,0,192,0,8,223,0,252,0,0,0,44,10,122,44,10,122,44,9,151,32,44,0,15,39,
    44,9,153,32,44,9,153,33,44,9,151,33,15,44,0,15,36,44,9,153,33,44,9,155,32,44,9,155,
    33,44,0,15,39,25,44,0,88,1,43,0,44,9,155,33,35,44,9,155,33,43,15,44,9,155,32,44,0,
    54,0,44,9,153,33,3,44,9,153,32,44,9,155,32,44,9,157,32,44,9,153,33,43,0,30,44,0,151,
    1,44,9,155,33,44,9,153,33,15,38,44,9,157,33,44,9,153,33,15,35,44,9,153,33,43,1,16,
    44,9,153,32,44,0,105,0,3,44,0,15,39,44,0,18,36,3,44,0,7,38,43,0,25,44,0,185,1,44,
    0,5,39,44,0,7,38,43,6,17,15,3,44,10,53,44,7,108,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,44,9,151,32,44,2,176,
    38,44,9,153,32,44,9,153,33,43,254,29,44,2,225,1,44,9,151,33,44,1,176,44,9,153,33,
    15,35,44,9,153,33,43,1,15,44,2,176,35,3,44,10,105,44,7,108,2,3,44,9,151,32,44,44,
    2,177,2,44,9,151,33,43,8,20,44,2,177,2,44,9,151,33,44,2,177,2,3,6,43,32,26,1,44,3,
    19,9,0,44,3,6,3,10,7,43,32,25,44,3,34,1,8,0,44,3,21,3,44,9,151,32,43,7,44,0,21,2,
    44,9,153,32,44,9,151,33,44,9,153,33,36,44,0,13,39,44,9,153,33,43,5,15,36,44,9,153,
    33,44,0,13,36,44,9,153,33,3,44,3,93,2,44,3,35,2,31,3,44,3,6,2,44,3,20,2,12,44,9,151,
    32,11,44,9,151,33,3,43,0,44,2,176,35,44,3,93,2,44,3,35,2,44,9,153,32,44,3,6,2,44,
    3,20,2,12,44,9,155,32,44,9,155,33,44,9,222,25,44,3,163,1,44,9,155,33,44,5,222,2,3,
    44,2,177,2,3,44,0,13,39,44,9,153,32,44,9,153,33,43,0,26,44,3,195,1,44,10,74,44,7,
    108,2,44,9,153,33,43,4,15,38,44,9,155,32,44,9,155,33,43,1,23,44,9,155,32,44,9,155,
    33,44,9,153,33,43,4,15,35,3,44,9,151,32,44,9,151,33,44,9,175,15,44,9,167,32,26,44,
    4,10,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,177,16,44,9,167,
    32,26,44,4,41,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,179,
    17,44,9,167,32,26,44,4,72,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,
    33,44,9,181,18,44,9,167,32,26,44,4,103,1,44,9,167,33,44,2,177,2,45,255,255,255,255,
    3,44,9,151,33,44,9,183,19,44,9,167,32,26,44,4,134,1,44,9,167,33,44,2,177,2,45,255,
    255,255,255,3,44,9,151,33,44,9,185,20,44,9,167,32,26,44,4,165,1,44,9,167,33,44,2,
    177,2,45,255,255,255,255,3,44,9,151,33,44,9,188,21,44,9,167,32,26,44,4,196,1,44,9,
    167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,191,22,44,9,167,32,26,44,
    4,227,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,195,23,44,9,
    167,32,26,44,5,2,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,198,
    24,44,9,167,32,26,44,5,33,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,
    33,44,9,202,25,44,9,167,32,26,44,5,64,1,44,9,167,33,44,2,177,2,45,255,255,255,255,
    3,44,9,151,33,44,9,205,26,44,9,167,32,26,44,5,95,1,44,9,167,33,44,2,177,2,45,255,
    255,255,255,3,44,9,151,33,44,9,208,27,44,9,167,32,26,44,5,126,1,44,9,167,33,44,2,
    177,2,45,255,255,255,255,3,44,9,151,33,44,9,211,28,44,9,167,32,26,44,5,157,1,44,9,
    167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,214,29,44,9,167,32,26,44,
    5,188,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,44,9,217,30,44,9,
    167,32,26,44,5,219,1,44,9,167,33,44,2,177,2,45,255,255,255,255,3,43,0,3,44,9,151,
    32,44,9,151,33,44,3,231,24,44,5,239,1,3,44,9,151,33,44,7,47,2,44,9,153,32,44,9,153,
    33,43,0,25,44,6,52,1,44,9,153,33,43,2,15,44,9,155,32,44,9,153,33,43,4,15,38,43,1,
    23,24,44,6,39,1,44,9,155,33,2,3,44,9,155,33,44,2,233,2,2,44,2,177,2,44,9,151,33,44,
    6,73,44,6,72,1,44,9,151,33,47,44,6,181,2,3,44,9,151,32,44,9,151,33,38,36,25,44,9,
    151,33,43,1,15,38,0,26,22,44,6,135,1,44,9,151,33,38,61,25,44,9,151,33,43,1,15,38,
    36,25,22,44,9,151,33,43,2,15,38,0,26,22,44,6,158,1,43,0,3,44,9,151,33,43,1,15,34,
    44,2,233,2,33,44,2,177,2,45,255,255,255,255,3,44,9,151,33,43,2,15,34,44,2,233,2,32,
    44,2,177,2,45,255,255,255,255,3,44,9,151,32,44,9,151,33,45,255,255,0,0,22,44,6,252,
    1,44,9,151,33,45,0,0,255,0,22,44,6,227,1,43,44,2,177,2,44,9,151,33,44,2,177,2,3,44,
    44,2,177,2,44,9,151,33,43,8,20,44,2,177,2,44,9,151,33,44,2,177,2,3,45,44,2,177,2,
    44,9,151,33,43,24,20,44,2,177,2,44,9,151,33,43,16,20,44,2,177,2,44,9,151,33,43,8,
    20,44,2,177,2,44,9,151,33,44,2,177,2,3,46,3,47,3,44,9,151,32,44,0,13,39,44,9,153,
    32,44,9,153,33,43,0,25,44,7,100,1,44,9,153,33,39,44,9,151,33,25,44,7,103,1,44,9,153,
    33,43,5,15,39,44,9,153,32,44,7,59,0,43,0,3,44,9,153,33,3,44,9,151,32,44,10,32,14,
    43,32,13,44,9,151,33,14,4,44,9,155,32,44,9,153,32,44,9,151,32,44,9,151,33,44,3,35,
    2,44,9,165,32,44,9,153,33,44,9,165,33,43,4,15,35,44,9,155,33,44,9,165,33,43,2,15,
    36,3,44,10,122,44,0,15,36,44,0,152,2,44,9,220,43,1,44,3,112,44,7,125,2,44,9,224,43,
    1,44,3,169,44,7,125,2,44,9,234,0,44,0,15,44,7,125,2,44,9,239,0,44,0,21,44,7,125,2,
    44,9,246,43,1,44,3,83,44,7,125,2,44,9,253,0,44,7,47,44,7,125,2,44,10,0,0,44,2,177,
    44,7,125,2,44,10,8,0,44,2,233,44,7,125,2,44,10,15,43,1,44,5,222,44,7,125,2,44,10,
    23,0,44,3,93,44,7,125,2,44,10,38,0,44,7,43,44,7,125,2,44,10,44,0,44,7,45,44,7,125,
    2,44,10,32,0,44,7,108,44,7,125,2,44,0,152,2,3,44,0,18,39,44,9,151,32,44,0,15,39,44,
    9,153,32,44,9,153,33,44,9,151,33,25,44,8,203,1,44,0,13,39,44,9,155,32,44,9,155,33,
    44,9,151,33,28,44,8,147,1,44,9,155,33,43,5,15,39,44,9,155,32,44,8,118,0,44,9,155,
    33,44,0,13,36,44,0,8,39,44,9,155,32,44,9,155,33,44,9,151,33,28,44,8,192,1,44,9,155,
    33,43,2,15,39,44,9,155,32,44,8,163,0,44,9,155,33,44,0,8,36,44,8,192,44,3,93,2,44,
    5,222,2,44,1,176,2,44,0,152,2,44,8,203,0,9,151,8,227,9,153,8,231,9,155,8,235,9,157,
    8,239,9,159,8,243,9,161,8,247,9,163,8,251,9,165,8,255,9,167,9,3,9,169,9,7,9,171,9,
    11,9,173,9,15,9,175,9,19,9,177,9,23,9,179,9,27,9,181,9,31,9,183,9,35,9,185,9,39,9,
    188,9,43,9,191,9,47,9,195,9,51,9,198,9,55,9,202,9,59,9,205,9,63,9,208,9,67,9,211,
    9,71,9,214,9,75,9,217,9,79,9,220,9,83,9,222,9,87,9,224,9,91,9,234,9,95,9,239,9,99,
    9,246,9,103,9,253,9,107,10,0,9,111,10,8,9,115,10,15,9,119,10,23,9,123,10,32,9,127,
    10,44,9,131,10,38,9,135,10,53,9,139,10,74,9,143,10,92,9,147,10,105,0,0,48,0,49,0,
    50,0,51,0,52,0,53,0,54,0,55,0,97,0,98,0,99,0,100,0,43,0,45,0,42,0,47,0,37,0,62,62,
    0,60,60,0,97,110,100,0,111,114,0,110,111,116,0,101,113,0,110,101,0,103,116,0,108,
    116,0,103,101,0,108,101,0,58,0,59,0,73,77,77,69,68,73,65,84,69,0,72,69,82,69,0,77,
    65,76,76,79,67,0,67,82,69,65,84,69,0,63,63,0,79,117,116,66,121,116,101,0,79,117,116,
    82,101,102,0,67,111,109,112,105,108,101,0,78,101,120,116,87,111,114,100,0,80,65,78,
    73,67,0,73,115,73,110,116,0,80,97,114,115,101,73,110,116,0,67,97,108,108,45,115,116,
    97,99,107,45,117,110,100,101,114,102,108,111,119,0,73,109,109,101,100,105,97,116,
    101,45,110,111,45,119,111,114,100,0,85,110,107,110,111,119,110,45,87,111,114,100,
    0,79,117,116,66,121,116,101,45,79,118,101,114,102,108,111,119,0,
};
